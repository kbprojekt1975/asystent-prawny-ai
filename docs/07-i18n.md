# 07 - Wielojęzyczność i Lokalizacja (i18n)

## Przegląd

Aplikacja **Asystent Prawny AI** wspiera pełną lokalizację w trzech językach:
- **Polski (PL)** - język domyślny
- **Angielski (EN)** - pełne tłumaczenie UI i promptów AI
- **Hiszpański (ES)** - pełne tłumaczenie UI i promptów AI

## Stos Technologiczny

### Frontend
- **react-i18next** - biblioteka do zarządzania tłumaczeniami w React
- **i18next** - core engine dla lokalizacji
- Pliki tłumaczeń: `src/locales/{pl,en,es}/translation.json`

### Backend
- Wielojęzyczne prompty systemowe w `functions/src/index.ts`:
  - `CORE_RULES_PL`, `CORE_RULES_EN`, `CORE_RULES_ES`
  - `PILLAR_RULES_PL`, `PILLAR_RULES_EN`, `PILLAR_RULES_ES`
  - `systemInstructions`, `systemInstructionsEn`, `systemInstructionsEs`

## Struktura Plików Tłumaczeń

```
src/locales/
├── pl/
│   └── translation.json
├── en/
│   └── translation.json
└── es/
    └── translation.json
```

### Przykładowa Struktura JSON

```json
{
  "app": {
    "title": "Asystent Prawny AI",
    "understand": "Rozumiem"
  },
  "law": {
    "header": "Wybierz dziedzinę prawa",
    "areas": {
      "prawo karne": "Prawo Karne",
      "prawo rodzinne": "Prawo Rodzinne"
    }
  },
  "interaction": {
    "header": "Wybierz tryb interakcji",
    "modes": {
      "advice": "Porada Prawna",
      "document": "Generowanie Pisma"
    }
  }
}
```

## Automatyczna Detekcja Języka

### Logika Wykrywania (i18n.ts)

1. **Sprawdzenie localStorage** - czy użytkownik wcześniej wybrał język
2. **Detekcja IP** - próba określenia kraju na podstawie adresu IP
3. **Ustawienia przeglądarki** - `navigator.language`
4. **Fallback** - domyślnie polski (PL)

```typescript
const savedLanguage = localStorage.getItem('i18nextLng');
if (savedLanguage) {
  return savedLanguage;
}

// IP-based detection
const response = await fetch('https://ipapi.co/json/');
const data = await response.json();
if (data.country_code === 'ES') return 'es';
if (data.country_code === 'GB' || data.country_code === 'US') return 'en';

// Browser language
const browserLang = navigator.language.split('-')[0];
return ['pl', 'en', 'es'].includes(browserLang) ? browserLang : 'pl';
```

## Przełączanie Języka

### Frontend (AppHeader.tsx)

Przyciski przełączania języka w nagłówku aplikacji:

```tsx
<button onClick={() => i18n.changeLanguage('pl')}>PL</button>
<button onClick={() => i18n.changeLanguage('en')}>EN</button>
<button onClick={() => i18n.changeLanguage('es')}>ES</button>
```

### Persystencja

Wybrany język jest automatycznie zapisywany w `localStorage` przez `i18next`.

## Backend - Wielojęzyczne Prompty AI

### Architektura Promptów

System używa modularnej architektury promptów:

1. **CORE_RULES** - Podstawowe zasady działania AI (PL/EN/ES)
2. **PILLAR_RULES** - Specjalistyczne instrukcje dla każdego obszaru prawa (PL/EN/ES)
3. **systemInstructions** - Instrukcje specyficzne dla trybu interakcji (PL/EN/ES)

### Dynamiczne Składanie Promptu

```typescript
const coreRules = language === 'en' ? CORE_RULES_EN : 
                  language === 'es' ? CORE_RULES_ES : 
                  CORE_RULES_PL;

const pillarRulesMap = language === 'en' ? PILLAR_RULES_EN : 
                       language === 'es' ? PILLAR_RULES_ES : 
                       PILLAR_RULES_PL;

const effectiveSystemInstructions = language === 'en' ? systemInstructionsEn : 
                                    language === 'es' ? systemInstructionsEs : 
                                    systemInstructions;
```

### Przykład Tłumaczenia Pillar Rules

**Polski:**
```typescript
"Prawo Karne": `
# ROLA: SĘDZIA KARNY I OBROŃCA
Działaj jako sędzia wydziału karnego oraz doświadczony obrońca...
`
```

**Angielski:**
```typescript
"Prawo Karne": `
# ROLE: CRIMINAL JUDGE AND DEFENSE ATTORNEY
Act as a criminal division judge and experienced defense attorney...
`
```

**Hiszpański:**
```typescript
"Prawo Karne": `
# ROL: JUEZ PENAL Y ABOGADO DEFENSOR
Actúa como juez de la división penal y abogado defensor experimentado...
`
```

## Funkcje Backend z Wsparciem i18n

### getLegalAdvice

Przyjmuje parametr `language` i dynamicznie dobiera prompty:

```typescript
export const getLegalAdvice = onCall({
  cors: true,
  secrets: [GEMINI_API_KEY]
}, async (request) => {
  const { language = 'pl', lawArea, interactionMode } = request.data;
  
  // Wybór odpowiednich promptów
  const coreRules = language === 'en' ? CORE_RULES_EN : 
                    language === 'es' ? CORE_RULES_ES : 
                    CORE_RULES_PL;
  // ...
});
```

### getLegalFAQ

Generuje pytania FAQ w wybranym języku:

```typescript
export const getLegalFAQ = onCall({
  cors: true,
  secrets: [GEMINI_API_KEY]
}, async (request) => {
  const { lawArea, language = 'pl' } = request.data;
  
  let prompt;
  if (language === 'en') {
    prompt = `You are a legal expert. Generate 4 FAQ questions in English...`;
  } else if (language === 'es') {
    prompt = `Eres un experto legal. Genera 4 preguntas FAQ en español...`;
  } else {
    prompt = `Jesteś ekspertem prawnym. Wygeneruj 4 pytania FAQ po polsku...`;
  }
  // ...
});
```

## Komponenty z Wsparciem i18n

### Przykład Użycia w Komponencie

```tsx
import { useTranslation } from 'react-i18next';

const MyComponent: React.FC = () => {
  const { t, i18n } = useTranslation();
  
  return (
    <div>
      <h1>{t('app.title')}</h1>
      <p>{t('law.header')}</p>
      <button onClick={() => i18n.changeLanguage('en')}>
        Switch to English
      </button>
    </div>
  );
};
```

### Dynamiczne Tłumaczenie Obszarów Prawa

```tsx
const lawAreaName = t(`law.areas.${lawArea.toLowerCase()}`);
```

## Najlepsze Praktyki

### 1. Konsystencja Kluczy
- Używaj snake_case dla kluczy: `law.areas.prawo_karne`
- Grupuj logicznie: `interaction.modes.advice`

### 2. Fallbacki
- Zawsze definiuj fallback dla brakujących tłumaczeń
- Używaj `t('key', { defaultValue: 'Default Text' })`

### 3. Pluralizacja
```json
{
  "items": "{{count}} element",
  "items_plural": "{{count}} elementy",
  "items_many": "{{count}} elementów"
}
```

### 4. Interpolacja
```json
{
  "welcome": "Witaj, {{name}}!"
}
```

Użycie:
```tsx
t('welcome', { name: 'Jan' }) // "Witaj, Jan!"
```

## Testowanie Wielojęzyczności

### Checklist
- [ ] Wszystkie teksty UI są przetłumaczone
- [ ] Backend generuje odpowiedzi w poprawnym języku
- [ ] FAQ są generowane w wybranym języku
- [ ] Przełączanie języka działa płynnie
- [ ] Język jest zapisywany w localStorage
- [ ] Automatyczna detekcja działa poprawnie

### Narzędzia
- **i18n-ally** (VS Code extension) - podświetlanie brakujących kluczy
- **Chrome DevTools** - testowanie localStorage
- **React DevTools** - sprawdzanie stanu i18n

## Rozszerzanie o Nowe Języki

### Krok 1: Dodaj Plik Tłumaczeń
```
src/locales/de/translation.json
```

### Krok 2: Zaktualizuj i18n.ts
```typescript
resources: {
  pl: { translation: plTranslation },
  en: { translation: enTranslation },
  es: { translation: esTranslation },
  de: { translation: deTranslation } // nowy język
}
```

### Krok 3: Dodaj Prompty Backend
```typescript
const CORE_RULES_DE = `...`;
const PILLAR_RULES_DE = {...};
const systemInstructionsDE = {...};
```

### Krok 4: Zaktualizuj Logikę Wyboru
```typescript
const coreRules = language === 'de' ? CORE_RULES_DE : 
                  language === 'en' ? CORE_RULES_EN : 
                  // ...
```

---
*Senior Full Stack Developer*
*Ostatnia aktualizacja: Styczeń 2026*
